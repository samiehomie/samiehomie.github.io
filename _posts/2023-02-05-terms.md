---
title: Webhook, Git Hook, GitHub Actions
author: sam
date: 2023-05-06 18:32:00 -0500
categories: [개발 사전, 용어]
tags: [VS Code, task]
---

## Webhook

> [Wikipedia](https://en.wikipedia.org/wiki/Webhook): Webhook은 웹 페이지나 웹 애플리케이션의 동작을 커스텀 콜백으로 보강하거나 변경하는 방법이다.

> [Red Hat](https://www.redhat.com/ko/topics/automation/what-is-a-webhook): 클라이언트 API는 서버 API를 호출하여 필요한 서버의 데이터에 변경이 있는지 확인한다. 이 프로세스(폴링)는 클라이언트가 서버의 상태를 알지 못하기 때문에 서버의 API가 관련 데이터를 전송할 때까지 규칙적인 간격으로 HTTP 요청을 전송해야 한다. 바면 Webhook는 서버 API에 특정 클라이언트 URL을 부여하고 알고자 하는 이벤트를 지정하여, 서버에서 지정된 이벤트가 발생하면 즉시 URL에 관련 데이터를 전송한다. 따라서 클라이언트는 더 이상 서버를 폴링할 필요가 없다.

정리하자면 서버가 통신의 주체가되어 서버에 특정 이벤트가 발생하면 클라이언트로 데이터를 전송(HTTP POST)하는 **역방향 API**다.

![webhook.jpg](/assets/img/etc/230511-webhooks.jpg)

## Git Hook

> **Note**: [공식 문서](https://git-scm.com/book/ko/v2/Git%EB%A7%9E%EC%B6%A4-Git-Hooks)에서 필요한 부분만 간추린 내용이다.

Git HooK을 사용하여 특정 이벤트에 특정 스크립트가 실행되도록 설정할 수 있다. 클라이언트 훅은 `commit`이나 `merge` 할 때 실행되고 서버 훅은 `push` 할 때 서버에서 실행된다.

### Git Hook 설치하기

기본 훅 디렉토리는 `.git/hooks`이다. 이 디렉토리에 가보면 Git이 자동으로 넣어준 유용한 스크립트 예제가 몇 개 있다. 모든 예제는 쉘과 Perl 스크립트로 작성돼 있지만 실행할 수만 있으면 되고 Ruby나 Python같은 다른 언어로 만들어도 된다. 예제 스크립트의 파일 이름에는 `.sample` 이라는 확장자가 붙어 있다. `.sample` 확장자를 지우면 그 훅을 바로 사용할 수 있다.

실행할 수 있는 스크립트 파일을 **확장자 없이** 저장소의 hooks 디렉토리에 넣으면 해당 스크립트가 훅으로 활성화되며, 이후 계속 호출된다.

### 클라이언트 훅

클라이언트 훅은 커밋 워크플로 훅과 이메일 워크플로 훅으로 나뉜다.

> **Note**: 저장소를 Clone 해도 클라이언트 훅은 복사되지 않는다. 반드시 적용되어야 할 정책이라면 서버 훅을 이용하자.

**커밋 워크플로 훅**

커밋과 관련된 훅은 모두 네 가지다.

- `pre-commit`: 커밋할 때 가장 먼저 호출되는 훅으로 커밋 메시지를 작성하기 전에 호출된다. 이 훅에서 커밋하는 Snapshot을 점검한다. 커밋할 때 꼭 확인해야 할 게 있으면 이 훅으로 확인한다. 이 훅의 `Exit` 코드가 0이 아니면 커밋은 취소된다. `git commit --no-verify` 라고 실행하면 이 훅을 일시적으로 생략할 수 있다.
- `prepare-commit-msg`: Git이 커밋 메시지를 생성하고 나서 편집기를 실행하기 전에 실행된다. 이 훅은 사람이 커밋 메시지를 수정하기 전에 먼저 프로그램으로 손보고 싶을 때 사용한다. 이 훅은 커밋 메시지가 들어 있는 파일의 경로, 커밋의 종류를 인수로 받는다. 그리고 최근 커밋을 수정할 때는(Amending 커밋) 추가로 SHA-1 값을 인수로 받는다. 이 훅은 일반 커밋에는 별로 필요 없고 커밋 메시지를 자동으로 생성하는 커밋에 좋다. 커밋 메시지에 템플릿을 적용하거나, Merge 커밋, Squash 커밋, Amend 커밋일 때 유용하다.
- `commit-msg`: 커밋 메시지가 들어 있는 임시 파일의 경로를 아규먼트로 받는다. 그리고 이 스크립트가 0이 아닌 값을 반환하면 커밋되지 않는다. 이 훅에서 최종적으로 커밋이 완료되기 전에 프로젝트 상태나 커밋 메시지를 검증한다. 커밋 메시지가 정책에 맞는지 검사하는 스크릅트를 넣기에 적합하다.
- `post-commit`: 커밋이 완료되면 실행된다. 일반적으로 이 스크립트는 커밋된 것을 누군가 혹은 다른 프로그램에게 알릴 때 사용한다.

**이메일 워크플로 훅**

여기에 속한 훅은 모두 `git am` 명령으로 실행된다. 아래는 `git am` 명령에서 실행되는 이메일 워크플로 훅을 순서대로 나열한 것이다.

1. `applypatch-msg`: 이 훅의 인수는 Author가 보내온 커밋 메시지 파일의 이름이다. 이 스크립트가 종료할 때 0이 아닌 값을 반환하면 Git은 Patch 하지 않는다. 커밋 메시지가 규칙에 맞는지 확인하거나 자동으로 메시지를 수정할 때 이 훅을 사용한다.
2. `pre-applypatch`: Patch를 적용하고 나서 실행돼 커밋할 스냅샷을 검사하는 데 사용한다. 이 스크립트로 테스트를 수행하고 파일을 검사할 수 있다. 테스트에 실패하거나 뭔가 부족하면 0이 아닌 값을 반환시켜서 git am 명령을 취소시킬 수 있다.
3. `post-applypatch`: 자동으로 Patch를 보낸 사람이나 그룹에게 알림 메시지를 보낼 수 있다. 이 스크립트로는 Patch를 중단시킬 수 없다.

**기타 클라이언트 훅**

- `pre-rebase`: Rebase 하기 전에 실행된다. 스크립트가 0이 아닌 값을 반환하면 Rebase가 취소된다. 이 훅으로 이미 Push 한 커밋을 Rebase 하지 못하게 할 수 있다. 샘플로 제공되는 pre-rebase가 그 예이다. 이 샘플에선 기준 브랜치가 next 라고 돼 있으므로 실제로 적용할 브랜치 이름으로 바꿔 사용하면 된다.
- `post-rewrite`: 커밋을 변경하는 명령을 실행했을 때 실행된다. 예를 들어 `git commit --amend` 이나 `git rebase` 같은 명령이 해당한다. `git filter-branch` 명령은 해당하지 않는다. 인수로 커밋을 변경하게 한 명령이 전달되고 stdin 으로 변경된 커밋 목록이 전달된다. 훅의 용도는 `post-checkout` 이나 `post-merge` 훅과 비슷하다고 볼 수 있다.
- `post-merge`: Merge가 끝나고 나서 실행된다. 이 훅은 파일 권한 같이 Git이 추적하지 않는 정보를 관리하는 데 사용한다. Merge로 Working Tree가 변경될 때 Git이 관리하지 않는 파일이 원하는 대로 잘 배치됐는지 검사할 때도 좋다.
- `pre-push`: `git push` 명령을 실행하면 동작하는데 리모트 정보를 업데이트 하고 난 후 리모트로 데이터를 전송하기 전에 동작한다. 리모트의 이름과 주소를 인수로 전달받으며 stdin 을 통해 업데이트 할 해시 리스트를 전달받는다. Push 하기 전에 커밋이 유효한지 확인하는 용도로 사용할 수 있다. 스크립트에서 0이 아닌 값을 반환하면 Push를 중지시킨다.
- `pre-auto-gc`: `git gc --auto` 명령으로 가비지 컬렉션이 실행되기 직전에 호출되는 훅으로 가비지 컬렉션이 동작한다고 사용자에게 알려주거나 지금 시점에 가비지 컬렉션이 동작하기엔 좋지 않다고 Git에 알려주는 용도로 사용할 수 있다.

### 서버 훅

서버 훅은 모두 Push 전후에 실행된다. Push 전에 실행되는 훅이 0이 아닌 값을 반환하면 해당 Push는 거절되고 클라이언트는 에러 메시지를 출력한다. 이 훅으로 아주 복잡한 Push 정책도 가능하다.

- `pre-receive`: Push 하면 가장 처음 실행되는 훅. stdin으로 Push 하는 Refs의 목록을 입력받는다. 스크립트가 0이 아닌 값을 반환하면 해당 Refs가 전부 거절된다. Fast-forward Push가 아니면 거절하거나, 브랜치 Push 권한을 제어하려면 이 훅에서 하는 것이 좋다. 관리자만 브랜치를 새로 Push 하고 삭제할 수 있고 일반 개발자는 수정사항만 Push 할 수 있게 할 수 있다.
- `update`: 각 브랜치마다 한 번씩 실행된다는 것을 제외하면 `pre-receive` 훅과 거의 같다. 한 번에 브랜치를 여러 개 Push 하면 pre-receive 는 딱 한 번만 실행되지만, update는 브랜치마다 실행된다. 인수로 브랜치 이름, 원래 가리키던 SHA-1 값, 사용자가 Push 하는 SHA-1 값을 입력받는다. 스크립트가 0이 아닌 값을 반환하면 해당 Refs만 거절한다.
- `post-receive`: Push 한 후에 실행된다. 이 훅으로 사용자나 서비스에 알림 메시지를 보낼 수 있다. stdin으로 Refs 목록을 받는다. 이 훅으로 메일링리스트에 메일을 보내거나, CI(Continuous Integration) 서버나 Ticket-tracking 시스템의 정보를 수정할 수 있다. 심지어 커밋 메시지도 파싱할 수 있기 때문에 이 훅으로 Ticket을 만들고, 수정하고, 닫을 수 있다. 이 스크립트가 완전히 종료할 때까지 클라이언트와의 연결은 유지되고 Push를 중단시킬 수 없다. 그래서 이 스크립트로 시간이 오래 걸릴만한 일을 할 때는 조심해야 한다.

## GitHub Actions

GitHub Actions는 빌드, 테스트 및 배포 파이프라인을 자동화할 수 있는 CI/CD(Continuous Integration and Continuous Delivery) 플랫폼이다. 저장소에 대한 모든 pull request를 빌드하고 테스트하는 워크플로우를 만들거나 머지된 pull request를 프로덕션에 배포할 수 있다.

GitHub Actions는 이와 같은 DevOps 기능을 넘어 저장소에 다른 이벤트가 발생할 때도 워크플로우를 실행할 수 있도록 지원한다. 예를 들어 워크플로를 실행하여 저장소에 새 issue가 생성될 때마다 적절한 레이블을 자동으로 추가하도록 할 수 있다.

GitHub에서 제공하는 Linux, Windows 및 macOS 가상 머신을 사용하여 워크플로우를 실행하거나 자체 데이터 센터 또는 클라우드 인프라에서 직접 호스팅하는 머신을 사용할 수도 있다.
